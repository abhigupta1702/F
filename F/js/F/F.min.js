/*! F - v0.1.0 - 2012-08-22
* http://lazd.github.com/F/
* Copyright (c) 2012 Lawrence Davis; Licensed BSD */
function Class(a){a=a||{},a.hasOwnProperty("extend")&&!a.extend&&console.warn("Class: %s is attempting to extend a non-truthy thing",a.toString==="function"?a.toString:a.toString,a.extend);var b=a.extend||Object,c=a.construct,d=a.destruct;delete a.extend,delete a.destruct,delete a.construct;if(a.hasOwnProperty("toString")&&typeof a.toString!="function"){var e=a.toString;a.toString=function(){return e.toString()}}else!a.hasOwnProperty("toString")&&b.prototype.hasOwnProperty("toString")&&(a.toString=b.prototype.toString);var f=a,g=Object.create(b&&b.prototype);g.superClass=b.prototype;if(f)for(var h in f)f.hasOwnProperty(h)&&(g[h]=f[h],typeof f[h]=="function"&&(g[h]._methodName=h,g[h]._parentProto=g));g.inherited=function(a){var b=a.callee,c=b._methodName;if(!c){console.error("Class.inherited: can't call inherited method: calling method did not have _methodName",a.callee);return}var d=b._parentProto,e=null;while(d.superClass){d=d.superClass,e=d[c];if(typeof e=="function")break}if(typeof e=="function"){var f=this.inherited;this.inherited=d.inherited;var g=e.apply(this,a);return this.inherited=f,g}console.warn("Class.inherited: can't call inherited method for '%s': no method by that name found",c)},g.bind=function(a){var b=a.bind(this);return b._methodName=a._methodName,this[b._methodName]=b,b},g.destruct=function(){typeof d=="function"&&d.apply(this),b&&b.prototype&&typeof b.prototype.destruct=="function"&&b.prototype.destruct.apply(this)},g.construct=function(){var a=arguments;a[0]===undefined&&(a.length=1,a[0]={}),b&&b.prototype&&typeof b.prototype.construct=="function"&&b.prototype.construct.apply(this,arguments),typeof c=="function"&&c.apply(this,arguments)};var i=function(){var a=Object.create(g);return g.construct.apply(a,arguments),a};return i.prototype=g,g.constructor=i,i}Object.create||(Object.create=function(a){function b(){}if(arguments.length>1)throw new Error("Object.create implementation only accepts the first parameter.");return b.prototype=a,new b}),Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var F=F||{};try{window["ƒ"]=F}catch(err){console.log("ƒ: could not set ƒ variable")}F.options={debug:!1,precompiledTemplates:!0},F.EventEmitter=new Class({construct:function(){this._events={}},destruct:function(){delete this._events},on:function(a,b){var c=this._events[a]=this._events[a]||[];return c.push(b),this},off:function(a,b){var c=this._events[a];return c===undefined,c.splice(c.indexOf(b),1),this},trigger:function(a){var b=this._events[a];if(b!==undefined)for(var c=0,d=b.length;c<d;c++)b[c].apply(this,Array.prototype.slice.call(arguments,1));return this}}),function(){var a=/^(\S+)\s*(.*)$/,b=function(a,b){return!a||!a[b]?null:_.isFunction(a[b])?a[b]():a[b]};F.View=Backbone.View.extend({initialize:function(){if(this.template||this.options.template)F.options.precompiledTemplates?this.template=this.template||this.options.template:this.template=Handlebars.template(this.template||this.options.template);this.render=this.render.bind(this);if(this.options.el){var a=this.$el[0].nodeName.toUpperCase(),b=this.tagName.toUpperCase();if(this.tagName!=="div"&&a!==b)throw new Error("View: cannot create view, incorrect tag provided. Expected "+b+", but got "+a);this.$el.addClass(this.className)}this.parent=this.options.parent,this.model=this.options.model,this.component=this.options.component,this.options.events&&this.delegateEvents(this.options.events),this.model&&this.model.on&&this.model.on("change",this.render),this.rendered=null},age:function(){return this.rendered!==null?(new Date).getTime()-this.rendered:-1},remove:function(){this.$el.remove(),this.model&&this.model.off("change",this.render)},show:function(){return this.template&&this.renderOnce(),this.$el.show(),this},hide:function(){return this.$el.hide(),this},renderOnce:function(){return this.rendered===null&&this.render(),this},render:function(){F.options.debug&&console.log("%s: Rendering view...",this.component&&this.component.toString()||"Orphaned view");if(this.template){var a=this.model||this.component&&this.component.model;this.$el.html(this.template(a&&a.toJSON&&a.toJSON()||a||{}))}return this.parent&&!$(this.el.parentNode).is(this.parent)&&$(this.parent).append(this.el),this.rendered=(new Date).getTime(),this.trigger("renderComplete"),this},delegateEvents:function(c){if(!c&&!(c=b(this,"events")))return;this.undelegateEvents();for(var d in c){var e=c[d],f=this.component;if(!_.isFunction(e))if(this.component){var g=c[d].split(".");if(g.length>1){e=this.component;for(var h=0;h<g.length;h++){var i=g[h];f=e,e=e[i];if(!e)break}}else e=this.component[c[d]]}else e=this[c[d]];if(!e)throw new Error('Method "'+c[d]+'" does not exist');var j=d.match(a),k=j[1],l=j[2];e=this.component?_.bind(e,f):_.bind(e,this),k+=".delegateEvents"+this.cid,l===""?this.$el.bind(k,e):this.$el.delegate(l,k,e)}return this}})}(),function(){function a(a){return a.slice(0,1).toLowerCase()+a.slice(1)}F.Component=new Class({toString:"Component",extend:F.EventEmitter,construct:function(a){this.mergeOptions({singly:!1,visible:!1},a),this.setPropsFromOptions(a,["singly","visible"]),this.components={},this._bubbledEvts={},this.bind(this._handleSubComponentShown),this.bind(this.render)},destruct:function(){this.view&&this.view.remove();for(var a in this.components)this.components[a].destruct(),delete this[a];delete this.components},render:function(){return this.view&&this.view.render(),this},bubble:function(a,b){if(!this[a])return console.error("%s: cannot set event '%s' for bubbling from component '%s', component does not exist",this.toString(),b,a),this;this._bubbledEvts[a]||(this._bubbledEvts[a]={});var c=this._bubbledEvts[a][b]=function(){var a=Array.prototype.slice.call(arguments);a.unshift(b),this.trigger.apply(this,a)}.bind(this);return this[a].on(b,c),this},unbubble:function(a,b){return!this._bubbledEvts[a]||!this._bubbledEvts[a][b]?(console.warn("%s: cannot discontinue bubbling of event '%s' for component '%s', event was not set for bubbling",this.toString(),b,a),this):(this[a].off(b,this._bubbledEvts[a][b]),this)},addComponent:function(b,c){return c?c=a(c):c=a(b.toString()),b.setName(c),this[c]=this.components[c]=b,b.view&&(b.view.el?b.visible===!0?b.show({silent:!0}):b.view.$el.hide():console.warn("Component %s has a view without an element",c,b,b.view,b.view.options)),b.on("component:shown",this._handleSubComponentShown),b},removeComponent:function(a){var b=this[a];return b!==undefined&&(b.off("component:shown",this._handleSubComponentShown),delete this[a],delete this.components[a]),this},_handleSubComponentShown:function(a){var b=this.components[a.name];b!==undefined&&(this.singly&&!b.overlay&&this.hideAllSubComponents([a.name]),this.show())},show:function(a){return a=a||{},F.options.debug&&(this.visible?console.log("%s: not showing self; already visible",this.toString()):console.log("%s: showing self",this.toString())),a.silent||this.trigger("component:shown",{name:this.toString(),component:this}),this.view&&this.view.show(),this.visible=!0,this},hide:function(a){return a=a||{},this.visible?(F.options.debug&&console.log("%s: hiding self",this.toString()),this.view&&this.view.hide(),a.silent||this.trigger("component:hidden",{name:this.toString(),component:this}),this.visible=!1,this):!1},isVisible:function(){return this.visible},showAllSubComponents:function(a){a=_.isArray(a)?a:[];for(var b in this.components){if(~a.indexOf(b))continue;this.components[b].show()}return this},hideAllSubComponents:function(a){a=_.isArray(a)?a:[];for(var b in this.components){if(~a.indexOf(b))continue;this.components[b].hide()}return this},setName:function(a){return this.toString=function(){return a},this},setPropsFromOptions:function(a,b){return _.each(b,function(b){this[b]=a[b]||this[b],delete a[b]}.bind(this)),this},mergeOptions:function(a,b){return _.extend(b,_.extend({},a||{},this.options||{},b)),b}})}(),F.ModelComponent=new Class({toString:"ModelComponent",extend:F.Component,construct:function(a){this.Model=this.Model||a.Model},Model:Backbone.Model,refresh:function(a){return this.model.fetch({success:function(){this.model.trigger("loaded"),this.trigger("model:loaded",this.model),typeof a=="function"&&a.call(this,this.model)}.bind(this)}),this},_setModel:function(a){return this.model&&this.model.off&&this.view&&this.model.off("change",this.view.render),this.model=a,this.view&&(this.view.rendered=null),this},fetch:function(a,b){var c={};a!==undefined&&(c[this.Model.prototype.idAttribute]=a);var d=new this.Model(c);return d.fetch({success:function(){this._setModel(d),this.trigger("model:loaded",this.model),typeof b=="function"&&b.call(this,d)}.bind(this)}),this},load:function(a){return a instanceof Backbone.Model?this._setModel(a):this._setModel(new this.Model(a)),this.trigger("model:loaded",this.model),this},save:function(a,b){return this.model?(F.options.debug&&console.log("%s: Saving...",this.toString()),this.model.save(a||{},{success:function(){F.options.debug&&console.log("%s: Save successful",this.toString()),typeof b=="function"&&b.call(this,this.model),this.trigger("model:saved",this.model)}.bind(this),error:function(a,b){console.warn("%s: Error saving model",this.toString()),this.trigger("model:saveFailed",{model:this.model,error:b})}.bind(this)})):console.warn("%s: Cannot save, model is not truthy",this.toString()),this},show:function(a){return a=a||{},a.id?(F.options.debug&&console.log("%s: fetching item with ID %s",this.toString(),a.id),this.fetch(a.id,function(b){F.options.debug&&console.log("%s: fetch complete!",this.toString()),this.show({silent:a.silent})})):a.model?(F.options.debug&&console.log("%s: showing with new model",this.toString(),a.model),this.load(a.model),this.show({silent:a.silent})):this.inherited(arguments),this}}),F.CollectionComponent=new Class({toString:"CollectionComponent",extend:F.Component,construct:function(a){this.setPropsFromOptions(a,["Collection"]),this.bind(this.addModel),this.bind(this.removeModel),this.bind(this.render),this._useCollection(new this.Collection),this.defaultParams=_.extend({},this.defaultParams,a.defaultParams),this.params=_.extend({},this.defaultParams),this.collectionLoaded=!1},destruct:function(){this._releaseCollection()},Collection:Backbone.Collection,_useCollection:function(a){this.collection=a,this.collection.on("add",this.addModel),this.collection.on("remove",this.removeModel),this.collection.on("loaded",this.render)},_releaseCollection:function(){this.collection.off("add",this.addModel),this.collection.off("remove",this.removeModel),this.collection.off("loaded",this.render),this.collection=null},refresh:function(a){return this.fetch(this.params,a),this},addModel:function(a){},removeModel:function(a){},clearParams:function(){return this.params={},this},fetch:function(a,b){return a?this.params=_.extend({},this.defaultParams,a):this.params=_.extend({},this.defaultParams),this.collection.fetch({data:this.params,success:function(){this.collection.trigger("loaded"),this.trigger("collection:loaded",this.collection),this.collectionLoaded=!0,typeof b=="function"&&b.call(this,this.collection)}.bind(this)}),this},load:function(a){return this._releaseCollection(),a instanceof Backbone.Collection?this._useCollection(a):this._useCollection(new this.Collection(a)),this},show:function(a){return a=a||{},a.params?this.fetch(a.params,function(){this.show({silent:a.silent})}):this.collectionLoaded?this.inherited(arguments):this.refresh(function(){this.show({silent:a.silent})}),this}}),function(){var a=F.View.extend({tagName:"form",events:{}});F.FormComponent=new Class({toString:"FormComponent",extend:F.ModelComponent,construct:function(a){this.setPropsFromOptions(a,["Model","View","Template"]),this.view=new this.View(_.extend({component:this,template:this.Template},a)),this.model=new this.Model,this.view.$el.on("submit",this.handleSubmit.bind(this))},View:a,Template:null,clear:function(){return this.model=new this.Model,this.render(),this},handleSubmit:function(a){this.view.$el.find('[type="submit"]').first().focus(),a.preventDefault();var b=this.view.$el.serializeArray(),c={};_.each(b,function(a){c[a.name]=a.value}),this.save(c)}})}(),function(){var a=F.View.extend({tagName:"ul",initialize:function(a){a=a||{},F.View.prototype.initialize.apply(this,arguments),this.collection=a.collection,this.ItemView=a.ItemView||this.ItemView,this.ItemTemplate=a.ItemTemplate||this.ItemTemplate,this.subViews=[],this.addSubView=this.addSubView.bind(this)},addSubView:function(a){var b=new this.ItemView({model:a,template:this.ItemTemplate,component:this.component});b.render(),this.$el.append(b.el),b.$el.data("viewIndex",this.subViews.length),this.subViews.push(b)},remove:function(){this.removeSubViews(),F.View.prototype.remove.call(this,arguments)},removeSubView:function(a){var b=null,c=-1;typeof c!="Number"?_.some(this.subViews,function(d,e){d&&d.model===a&&(b=d,c=e)}.bind(this)):b=this.subViews[c],b&&(b.remove(),this.subViews[c]=undefined)},removeSubViews:function(){this.subViews.length&&(_.each(this.subViews,function(a){a&&a.remove()}),this.subViews=[])},render:function(){return F.options.debug&&console.log("%s: rendering list view...",this.component&&this.component.toString()||"List view"),this.parent&&!$(this.el.parentNode).is(this.parent)&&$(this.parent).append(this.el),this.removeSubViews(),this.collection.each(this.addSubView),this.rendered=(new Date).getTime(),this.trigger("renderComplete"),this}}),b=F.View.extend({tagName:"li",className:"listItem"});F.ListComponent=new Class({toString:"ListComponent",extend:F.CollectionComponent,construct:function(a){this.setPropsFromOptions(a,["Collection","ListTemplate","ListView","ItemTemplate","ItemView"]),this.view=new this.ListView(_.extend({component:this,collection:this.collection,ItemView:this.ItemView,ItemTemplate:this.ItemTemplate,events:{"click li":"handleSelect"}},a)),this.selectedItem=null},Collection:Backbone.Collection,ListTemplate:null,ListView:a,ItemTemplate:null,ItemView:b,addModel:function(a){this.view.addSubView(a)},removeModel:function(a){this.view.removeSubView(a)},getModelFromLi:function(a){return this.view.subViews[$(a).data("viewIndex")].model},getViewFromLi:function(a){return this.view.subViews[$(a).data("viewIndex")]},handleSelect:function(a){var b=this.getModelFromLi(a.currentTarget);this.selectedItem=b.id,this.trigger("list:itemSelected",{listItem:$(a.currentTarget),model:b})}})}();